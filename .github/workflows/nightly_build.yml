name: Nightly Android Build

on:
  schedule:
    - cron: '0 1 * * *' 
  workflow_dispatch:

jobs:
  check_for_changes: 
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.compare.outputs.should_run }} 
    steps:
      - name: Fetch last nightly tag
        id: tag
        run: |
          # Find the latest 'nightly-YYYY-MM-DD' tag
          TAG_NAME=$(git ls-remote --tags --sort='v:refname' origin | grep 'refs/tags/nightly-' | tail -n 1 | awk -F'/' '{print $3}')
          echo "LAST_TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          if [ -z "$TAG_NAME" ]; then
            # If no tag is found, we should run the build (it's the first one)
            echo "LAST_TAG_SHA=$GITHUB_SHA" >> $GITHUB_ENV
            echo "No nightly tag found. Proceeding with build."
          else
            # Get the commit SHA for the latest tag
            LAST_TAG_SHA=$(git ls-remote origin refs/tags/$TAG_NAME | awk '{print $1}')
            echo "LAST_TAG_SHA=$LAST_TAG_SHA" >> $GITHUB_ENV
            echo "Found last tag $TAG_NAME at $LAST_TAG_SHA"
          fi
          
      - name: Compare with current branch
        id: compare
        run: |
          # Get the latest commit SHA of the current main branch
          MAIN_SHA=$(git rev-parse HEAD)
          
          # Compare the list of commits between the two SHAs
          if [ "$(git rev-list ${{ env.LAST_TAG_SHA }}..$MAIN_SHA | wc -l)" -gt 0 ]; then
            echo "Changes detected since last nightly tag. Running build."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected since last nightly tag. Skipping build."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
          
  build_and_release:
    runs-on: ubuntu-latest
    needs: check_for_changes
    if: needs.check_for_changes.outputs.should_run == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug

      - name: Set Run Date
        id: date
        run: echo "RUN_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ env.RUN_DATE }}
          name: Nightly Build ${{ env.RUN_DATE }}
          prerelease: true
          files: |
            ./**/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
